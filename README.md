# Интеграция Эвотор с 1С

Android-приложение для интеграции смарт-терминала Эвотор с системой 1С через API Облака Эвотор.

## Описание

Приложение является товароучетной системой, которая:
- Работает через официальное API Облака Эвотор
- Авторизуется с помощью Bearer-токена приложения
- Синхронизирует документы (чеки, возвраты) и номенклатуру
- Получает события о продажах в реальном времени
- Предоставляет интерфейс для настройки и мониторинга синхронизации

## Технические требования

- **Min SDK:** 26 (Android 8.0)
- **Target SDK:** 33 (Android 13)
- **Java:** 8 (VERSION_1_8)
- **Gradle:** 7.4.2
- **Библиотеки:**
  - Evotor Integration Library v0.6.+
  - OkHttp 4.10.0
  - Gson 2.10.1
  - AndroidX AppCompat 1.6.1
  - Material Components 1.9.0

## Архитектура проекта

```
com.evotor.integration/
├── MainActivity.java              # Главный экран с логом операций
├── SettingsActivity.java          # Экран настроек токена
├── api/
│   ├── EevotorApiClient.java     # HTTP клиент для API Облака
│   └── models/
│       ├── Product.java           # Модель товара
│       ├── Document.java          # Модель документа
│       └── ApiResponse.java       # Обертка ответа API
├── receivers/
│   └── ReceiptBroadcastReceiver.java  # Получение событий о продажах
├── services/
│   └── SyncService.java           # Сервис синхронизации
└── utils/
    ├── PreferencesHelper.java     # Работа с настройками
    └── Logger.java                # Логирование событий
```

## Установка и настройка

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd EevotorIntegration
```

### 2. Сборка проекта

```bash
./gradlew build
```

### 3. Получение токена API Эвотор

1. Войдите в личный кабинет Эвотор
2. Откройте раздел приложений
3. Создайте новое приложение или откройте существующее
4. В настройках включите следующие опции:
   - "Получение номенклатуры и остатков в стороннем сервисе"
   - "Получать документы из облака Эвотор"
   - "Управление номенклатурой из облака"
5. Скопируйте токен приложения из вкладки "Настройки"

### 4. Настройка приложения

1. Установите APK на терминал Эвотор
2. Запустите приложение
3. Нажмите "Настройки"
4. Вставьте скопированный токен в поле "Токен API Эвотор"
5. Нажмите "Сохранить"
6. Нажмите "Проверить соединение" для проверки токена

## Использование

### Главный экран

На главном экране отображается:
- **Статус синхронизации:** текущее состояние (ожидание/выполняется/ошибка)
- **Последняя синхронизация:** дата и время последней успешной синхронизации
- **Лог операций:** подробная информация обо всех операциях в реальном времени

### Кнопки управления

- **Запустить синхронизацию** - запускает синхронизацию документов и товаров вручную
- **Настройки** - открывает экран настройки токена
- **Очистить лог** - очищает журнал операций

### Автоматические события

Приложение автоматически получает события о:
- Продажах (чеки)
- Возвратах
- Приходах
- Возвратах прихода

Все события логируются и могут быть обработаны для отправки в 1С.

## API Облака Эвотор

Приложение использует следующие endpoints:

### Проверка соединения
```
GET https://api.evotor.ru/api/v1/stores
Authorization: Bearer {token}
```

### Получение документов
```
GET https://api.evotor.ru/api/v1/inventories/stores/{storeUuid}/documents
Authorization: Bearer {token}
```

### Получение товаров
```
GET https://api.evotor.ru/api/v1/inventories/stores/{storeUuid}/products
Authorization: Bearer {token}
```

## Структура данных

### Document (Документ)
```java
{
  "uuid": "string",
  "type": "string",
  "date": "string",
  "deviceUuid": "string",
  "storeUuid": "string",
  "totalSum": double,
  "transactions": [...]
}
```

### Product (Товар)
```java
{
  "uuid": "string",
  "name": "string",
  "price": double,
  "quantity": double,
  "barcode": "string",
  "articleNumber": "string",
  "code": "string",
  "measureName": "string",
  "tax": "string"
}
```

## Разработка

### Добавление новых функций

1. Для работы с новыми типами данных создайте модель в `api/models/`
2. Добавьте методы в `EevotorApiClient.java` для работы с новыми endpoints
3. Обновите `SyncService.java` для синхронизации новых данных
4. При необходимости добавьте новые BroadcastReceiver для событий

### Отладка

Все операции логируются через класс `Logger`. Для просмотра логов:
- В приложении: на главном экране в разделе "Лог операций"
- В Logcat: фильтр по тегу "EevotorIntegration"

### Тестирование API

Для тестирования API используйте:
1. Кнопку "Проверить соединение" в настройках
2. Кнопку "Запустить синхронизацию" на главном экране
3. Logcat для детальной информации о запросах

## Безопасность

- Токен API хранится в SharedPreferences приложения
- Все запросы к API используют HTTPS
- Приложение требует разрешения:
  - `INTERNET` - для работы с API
  - `ACCESS_NETWORK_STATE` - для проверки соединения
  - `ru.evotor.permission.RECEIPT_ACCESS` - для получения событий о чеках

## Известные ограничения

1. Для тестирования используется фиксированный UUID магазина
2. Не реализовано сохранение данных в локальную БД
3. Не реализована отправка данных в 1С (требуется интеграция с API 1С)
4. Lambda выражения отключены (требование Эвотор)

## Следующие шаги

1. Интеграция с API 1С для отправки документов
2. Добавление локальной базы данных (Room) для кэширования
3. Реализация фоновой синхронизации (WorkManager)
4. Добавление обработки конфликтов синхронизации
5. Реализация получения списка магазинов и выбора активного

## Документация

- [Официальная документация Эвотор](https://developer.evotor.ru)
- [API Облака Эвотор](https://api.evotor.ru/docs/)
- [Integration Library](https://github.com/evotor/integration-library)
- [Интеграция с 1С](https://developer.evotor.ru/docs/doc_1C_integration.html)

## Лицензия

Проект разработан для интеграции с платформой Эвотор.

## Контакты

Для вопросов по разработке приложений для Эвотор: developer@evotor.ru
